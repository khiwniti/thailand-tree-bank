# üöÄ Complete Deployment Guide - Frontend & Backend

## Overview

This guide will help you deploy:
- ‚úÖ **Frontend** ‚Üí Cloudflare Pages (Fast, Free, Global CDN)
- ‚úÖ **Backend** ‚Üí Railway / Render / Fly.io (PostgreSQL + Redis support)

## Part 1: Frontend Deployment (Cloudflare Pages)

### Option A: Automatic Deployment (GitHub Integration)

**‚úÖ Recommended - Easiest Method**

1. **Your repo is already pushed!** ‚úÖ
   ```bash
   # Already done:
   # git push origin main
   ```

2. **Go to Cloudflare Dashboard**
   - Visit: https://dash.cloudflare.com/
   - Click: **Workers & Pages** ‚Üí **Create application** ‚Üí **Pages** ‚Üí **Connect to Git**

3. **Connect GitHub Repository**
   - Select: `khiwniti/thailand-tree-bank`
   - Branch: `main`

4. **Configure Build Settings**
   ```
   Project name: thailand-tree-bank
   Production branch: main
   Build command: cd frontend && npm install && npm run build
   Build output directory: frontend/dist
   Root directory: /
   ```

5. **Add Environment Variables**
   Click "Add environment variable" for each:

   **Required:**
   ```
   VITE_LIFF_ID = 2008934197-jM9Zoogn
   ```

   **Optional (Recommended):**
   ```
   VITE_OPENROUTER_API_KEY = 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
   VITE_API_URL = https://your-backend-url.railway.app
   ```

   ‚ö†Ô∏è **Note:** Set `VITE_API_URL` after deploying backend in Part 2

6. **Save and Deploy**
   - Click **Save and Deploy**
   - Wait ~2 minutes for build
   - Get your URL: `https://thailand-tree-bank.pages.dev`

7. **Update Custom Domain (Optional)**
   - Go to **Custom domains** tab
   - Add: `b02bd34b.thailand-tree-bank.pages.dev` or your custom domain

### Option B: Manual Deployment (Wrangler CLI)

```bash
# Install Wrangler globally
npm install -g wrangler

# Login to Cloudflare
wrangler login

# Navigate to frontend
cd frontend

# Deploy
wrangler pages deploy dist --project-name=thailand-tree-bank

# Or use our script
cd ..
./scripts/deploy-cloudflare.sh
```

### Verify Frontend Deployment

```bash
# Check your deployment
curl -I https://thailand-tree-bank.pages.dev

# Should return: HTTP/2 200
```

Visit: https://thailand-tree-bank.pages.dev
- ‚úÖ Should show beautiful UI with demo mode
- ‚úÖ Or login screen if VITE_LIFF_ID is set

---

## Part 2: Backend Deployment

### ‚ö†Ô∏è Important: Why Not Cloudflare Workers?

Your backend uses:
- PostgreSQL + Prisma ORM
- Redis caching
- File uploads (multer)
- Express.js with middleware

**Cloudflare Workers limitations:**
- ‚ùå No PostgreSQL (only D1 SQLite)
- ‚ùå No Redis
- ‚ùå No file system
- ‚ùå 10ms-50ms CPU limits
- ‚ùå Would require complete rewrite

### ‚úÖ Recommended: Railway (Free tier available)

**Why Railway?**
- ‚úÖ Free PostgreSQL database
- ‚úÖ Free Redis cache
- ‚úÖ Automatic deployments from GitHub
- ‚úÖ Environment variables management
- ‚úÖ Built-in logs and monitoring

### Deploy Backend to Railway

#### 1. Create Railway Account
- Visit: https://railway.app/
- Sign up with GitHub
- Free tier: $5/month credit

#### 2. Create New Project
```bash
# Install Railway CLI
npm install -g @railway/cli

# Login
railway login

# Link project (from repo root)
cd backend
railway init

# Or use web interface:
# 1. Go to: https://railway.app/new
# 2. Click "Deploy from GitHub repo"
# 3. Select: khiwniti/thailand-tree-bank
# 4. Set root directory: /backend
```

#### 3. Add PostgreSQL Database
```bash
# Via CLI
railway add -d postgres

# Or via web:
# 1. In your project, click "+ New"
# 2. Select "Database" ‚Üí "PostgreSQL"
# 3. Railway auto-creates DATABASE_URL
```

#### 4. Add Redis (Optional but recommended)
```bash
# Via CLI
railway add -d redis

# Or via web:
# 1. Click "+ New" ‚Üí "Database" ‚Üí "Redis"
# 2. Railway auto-creates REDIS_URL
```

#### 5. Configure Environment Variables

In Railway dashboard, add these variables:

```bash
# Auto-generated by Railway:
DATABASE_URL=postgresql://...  # ‚úÖ Auto-set
REDIS_URL=redis://...          # ‚úÖ Auto-set

# You need to add:
PORT=8080
NODE_ENV=production
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production-12345
LINE_CHANNEL_SECRET=your-line-channel-secret
FRONTEND_URL=https://thailand-tree-bank.pages.dev
GEMINI_API_KEY=your-gemini-key-if-needed

# For Redis TLS (if Railway uses TLS):
REDIS_TLS=true
REDIS_SNI=your-redis-hostname
```

#### 6. Configure Build Settings

Railway should auto-detect, but verify:

```bash
# Build Command
npm install && npx prisma generate && npm run build

# Start Command
npm start

# Root Directory
backend
```

#### 7. Deploy
```bash
# Via CLI
railway up

# Or push to GitHub (auto-deploys)
git push origin main
```

#### 8. Run Database Migrations
```bash
# Via Railway CLI
railway run npx prisma db push

# Or via Railway web:
# 1. Go to your service
# 2. Click "Settings" ‚Üí "Deploy"
# 3. Add build command: npx prisma db push && npm run build
```

#### 9. Get Your Backend URL
```bash
# Via CLI
railway domain

# Example: thailand-tree-bank-production.up.railway.app
```

### Alternative: Deploy to Render

If Railway doesn't work, try Render.com:

```bash
# 1. Visit: https://render.com
# 2. Sign up with GitHub
# 3. New ‚Üí Web Service
# 4. Connect: khiwniti/thailand-tree-bank
# 5. Settings:
#    - Name: thailand-tree-bank-backend
#    - Root Directory: backend
#    - Build Command: npm install && npx prisma generate && npm run build
#    - Start Command: npm start
# 6. Add PostgreSQL database (free tier)
# 7. Add environment variables (same as Railway)
# 8. Deploy
```

---

## Part 3: Connect Frontend to Backend

### 1. Get Backend URL

After backend deployment, you'll get a URL like:
```
https://thailand-tree-bank-production.up.railway.app
```

### 2. Update Frontend Environment Variables

**In Cloudflare Pages:**

1. Go to: https://dash.cloudflare.com/
2. Navigate: **Workers & Pages** ‚Üí **thailand-tree-bank** ‚Üí **Settings** ‚Üí **Environment variables**
3. Edit `VITE_API_URL`:
   ```
   VITE_API_URL = https://thailand-tree-bank-production.up.railway.app
   ```
4. **Save**

### 3. Redeploy Frontend

**Option A: Trigger via Cloudflare**
1. Go to **Deployments** tab
2. Click **‚ãØ** on latest deployment
3. Click **Retry deployment**

**Option B: Push to GitHub**
```bash
# Make a small change
echo "# Updated $(date)" >> README.md
git add .
git commit -m "Update API URL"
git push origin main
```

### 4. Verify Connection

```bash
# Test backend health
curl https://thailand-tree-bank-production.up.railway.app/health

# Should return:
# {"status":"ok","timestamp":"..."}

# Test from frontend
# Open: https://thailand-tree-bank.pages.dev
# Open browser console (F12)
# Check for API calls to your backend URL
```

---

## Part 4: Update LINE LIFF Settings

### 1. Update LIFF Endpoint URL

1. Go to: https://developers.line.biz/console/
2. Select your provider
3. Find your LIFF app: `2008934197-jM9Zoogn`
4. Update **Endpoint URL**:
   ```
   https://thailand-tree-bank.pages.dev
   ```
5. **Save**

### 2. Test LIFF Integration

Send this to yourself in LINE:
```
https://liff.line.me/2008934197-jM9Zoogn
```

Should open your app with LINE authentication!

---

## Quick Deployment Commands

### Frontend (Cloudflare Pages)
```bash
# Build locally
cd frontend
npm run build

# Deploy with Wrangler
wrangler pages deploy dist --project-name=thailand-tree-bank

# Or use script
cd ..
./scripts/deploy-cloudflare.sh
```

### Backend (Railway)
```bash
# Link to Railway
cd backend
railway link

# Deploy
railway up

# Run migrations
railway run npx prisma db push

# View logs
railway logs

# Open web
railway open
```

---

## Environment Variables Summary

### Frontend (Cloudflare Pages)
```bash
VITE_LIFF_ID=2008934197-jM9Zoogn
VITE_OPENROUTER_API_KEY=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
VITE_API_URL=https://your-backend.railway.app
```

### Backend (Railway/Render)
```bash
# Auto-generated:
DATABASE_URL=postgresql://...
REDIS_URL=redis://...

# You set:
PORT=8080
NODE_ENV=production
JWT_SECRET=your-secret-key
LINE_CHANNEL_SECRET=your-line-secret
FRONTEND_URL=https://thailand-tree-bank.pages.dev
GEMINI_API_KEY=optional
REDIS_TLS=true
REDIS_SNI=your-redis-host
```

---

## Troubleshooting

### Frontend Issues

**Problem: Demo banner still showing**
- ‚úÖ Check: `VITE_LIFF_ID` is set in Cloudflare
- ‚úÖ Trigger: New deployment
- ‚úÖ Clear: Browser cache (Ctrl+Shift+R)

**Problem: API calls failing**
- ‚úÖ Check: `VITE_API_URL` points to correct backend
- ‚úÖ Check: Backend CORS allows frontend URL
- ‚úÖ Check: Backend is running (visit /health endpoint)

### Backend Issues

**Problem: Database connection error**
- ‚úÖ Check: `DATABASE_URL` is set
- ‚úÖ Run: `railway run npx prisma db push`
- ‚úÖ Check: PostgreSQL is running in Railway

**Problem: Prisma Client not generated**
- ‚úÖ Add to build command: `npx prisma generate`
- ‚úÖ Or add postinstall: `"postinstall": "prisma generate"`

**Problem: Redis connection timeout**
- ‚úÖ Redis is optional, app works without it
- ‚úÖ Check: `REDIS_URL` format
- ‚úÖ For TLS: Set `REDIS_TLS=true` and `REDIS_SNI`

---

## Monitoring & Logs

### Frontend (Cloudflare)
```bash
# View deployments
wrangler pages deployment list --project-name=thailand-tree-bank

# View logs (real-time via dashboard)
# https://dash.cloudflare.com/ ‚Üí Your Project ‚Üí Logs
```

### Backend (Railway)
```bash
# View logs
railway logs

# Follow logs (real-time)
railway logs --follow

# View specific service
railway logs --service=backend
```

---

## Costs

### Frontend (Cloudflare Pages)
- ‚úÖ **Free tier**: Unlimited requests
- ‚úÖ 500 builds/month
- ‚úÖ Global CDN included

### Backend (Railway)
- ‚úÖ **Free tier**: $5/month credit
- ‚úÖ PostgreSQL: Free tier available
- ‚úÖ Redis: Free tier available
- üí∞ **Paid**: $5-20/month for production

### Alternative: Render
- ‚úÖ **Free tier**: Web service + PostgreSQL
- ‚è±Ô∏è Spins down after inactivity (slow cold starts)
- üí∞ **Paid**: $7/month for always-on

---

## Next Steps

1. ‚úÖ Frontend deployed to Cloudflare Pages
2. ‚úÖ Backend deployed to Railway/Render
3. ‚úÖ Environment variables configured
4. ‚úÖ LIFF endpoint updated
5. üéâ **Test your app in LINE!**

---

## Support

**Documentation:**
- Quick Fix: `QUICK_FIX.md`
- Cloudflare Setup: `CLOUDFLARE_SETUP.md`
- API Docs: `docs/api/endpoints.md`

**Commands:**
```bash
# Deploy frontend
./scripts/deploy-cloudflare.sh

# Check Railway status
railway status

# View all tasks
railway list
```

üéâ **Your Thailand Tree Bank is now live!** üå≥
